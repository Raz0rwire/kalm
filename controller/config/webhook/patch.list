# the webhook file: config/webhook/manifests.yaml is generated by controller-gen (make manifest)
# ordering of webhooks inside MutatingWebhookConfiguration and ValidatingWebhookConfiguration are determined by alphabetic ordering of the file names where `// +kubebuilder:webhook` is defined
# first dir `api/v1alpha1/ `, then dir `api/builtin/`
#
# so if new CRD added or deleted, the following number in path need to be *manually* updated, otherwise the patch will be added to wrong webhook

# relationship between objectSelector and namespaceSelector is: AND
# so webhooks below will only works within namespace with label:
#  - kalm-enabled: true
#
# and object with label:
#  - tenant

# ns
- op: add
  path: /webhooks/14/namespaceSelector
  value:
    matchLabels:
      kalm-enabled: "true"
    matchExpressions:
      - { key: tenant, operator: Exists }
      - { key: kalm-control-plane, operator: DoesNotExist }
# pod
- op: add
  path: /webhooks/15/objectSelector
  value:
    matchExpressions:
      - { key: tenant, operator: Exists }
- op: add
  path: /webhooks/15/namespaceSelector
  value:
    matchLabels:
      kalm-enabled: "true"
    matchExpressions:
      - { key: kalm-control-plane, operator: DoesNotExist }
# pvc
- op: add
  path: /webhooks/16/objectSelector
  value:
    matchExpressions:
      - { key: tenant, operator: Exists }
- op: add
  path: /webhooks/16/namespaceSelector
  value:
    matchLabels:
      kalm-enabled: "true"
    matchExpressions:
      - { key: kalm-control-plane, operator: DoesNotExist }
# svc
- op: add
  path: /webhooks/17/objectSelector
  value:
    matchExpressions:
      - { key: tenant, operator: Exists }
- op: add
  path: /webhooks/17/namespaceSelector
  value:
    matchLabels:
      kalm-enabled: "true"
    matchExpressions:
      - { key: kalm-control-plane, operator: DoesNotExist }